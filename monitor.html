<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioMotion - ç›£æ§ç«¯ (é™¤éŒ¯æ¨¡å¼)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        :root { --bg: #FAF9F6; --accent: #800020; }
        body { background: var(--bg); font-family: sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* é™¤éŒ¯è¦–çª—æ¨£å¼ */
        #debug-console {
            width: 90%; max-width: 600px; height: 150px;
            background: #333; color: #0f0; font-family: monospace;
            padding: 10px; overflow-y: scroll; border-radius: 8px;
            margin-bottom: 20px; font-size: 12px;
        }

        .controls { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input { padding: 10px; font-size: 16px; border: 1px solid #ccc; width: 120px; text-align: center; }
        button { padding: 10px 20px; background: var(--accent); color: white; border: none; font-size: 16px; cursor: pointer; border-radius: 4px; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        #video-container { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .vid-box { width: 320px; height: 400px; background: black; position: relative; }
        video, canvas { width: 100%; height: 100%; object-fit: cover; }
        video { display: none; }
        .label { position: absolute; top: 5px; left: 5px; background: rgba(128,0,32,0.8); color: white; padding: 2px 8px; font-size: 12px; }
    </style>
</head>
<body>

    <h2>BioMotion ç›£æ§ç«¯ (é™¤éŒ¯ç‰ˆ)</h2>
    
    <div id="debug-console">ç³»çµ±å•Ÿå‹•ä¸­...<br></div>

    <div class="controls">
        <p>è«‹è¼¸å…¥æ‰‹æ©Ÿä¸Šçš„ 4 ä½æ•¸ IDï¼š</p>
        <input type="text" id="target-id" placeholder="ä¾‹å¦‚ 8851">
        <button id="btn-connect" onclick="startConnection()" disabled>ç­‰å¾…ç³»çµ±å°±ç·’...</button>
    </div>

    <div id="video-container"></div>

    <script>
        // --- é™¤éŒ¯å·¥å…·ï¼šæŠŠ console.log å°åœ¨ç•«é¢ä¸Š ---
        function log(msg) {
            const box = document.getElementById('debug-console');
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `[${time}] ${msg}<br>`;
            box.scrollTop = box.scrollHeight;
            console.log(msg);
        }

        // --- PeerJS åˆå§‹åŒ– ---
        const peer = new Peer();
        let myMonitorId = null;

        peer.on('open', (id) => {
            myMonitorId = id;
            log(`âœ… é›»è…¦ç«¯é€£ç·šæˆåŠŸï¼æˆ‘çš„ ID: ${id}`);
            log(`ğŸ‘‰ ç¾åœ¨è«‹è¼¸å…¥æ‰‹æ©Ÿ ID ä¸¦æŒ‰é€£ç·š`);
            
            // è§£é–æŒ‰éˆ•
            const btn = document.getElementById('btn-connect');
            btn.disabled = false;
            btn.innerText = "é–‹å§‹é€£ç·š";
            btn.style.backgroundColor = "#800020";
        });

        peer.on('error', (err) => {
            log(`âŒ ç³»çµ±éŒ¯èª¤: ${err.type}`);
        });

        // ç•¶æ‰‹æ©Ÿã€Œå›æ’¥ã€å½±åƒéä¾†æ™‚
        peer.on('call', (call) => {
            log(`ğŸ“ æ”¶åˆ°ä¾†è‡ªæ‰‹æ©Ÿ (${call.peer}) çš„å½±åƒä¸²æµè«‹æ±‚...`);
            call.answer(null); // æ¥è½
            
            call.on('stream', (remoteStream) => {
                log(`ğŸ¬ å½±åƒè¨Šè™Ÿå·²æ¥æ”¶ï¼æ­£åœ¨é¡¯ç¤º...`);
                showVideo(call.peer, remoteStream);
            });
            
            call.on('error', (err) => {
                log(`âŒ å½±åƒå‚³è¼¸éŒ¯èª¤: ${err}`);
            });
        });

        // --- ä¸»å‹•é€£ç·šé‚è¼¯ ---
        function startConnection() {
            const targetId = document.getElementById('target-id').value.trim();
            if (!targetId) {
                alert("è«‹è¼¸å…¥ ID");
                return;
            }

            log(`ğŸš€ å˜—è©¦é€£ç·šåˆ°æ‰‹æ©Ÿ ID: ${targetId}...`);
            
            // å»ºç«‹æ•¸æ“šé€£ç·š (Data Connection) ç”¨ä¾†è§¸ç™¼æ‰‹æ©Ÿ
            const conn = peer.connect(targetId);

            conn.on('open', () => {
                log(`âœ… å·²é€£æ¥åˆ°æ‰‹æ©Ÿ (${targetId})ï¼ç­‰å¾…æ‰‹æ©Ÿå›å‚³å½±åƒ...`);
                // é€™è£¡å¦‚æœä¸é€è³‡æ–™ï¼Œæœ‰äº›ç€è¦½å™¨ä¸æœƒè§¸ç™¼ openï¼Œæ‰€ä»¥æˆ‘å€‘é€ä¸€å€‹ç©ºåŒ…
                conn.send("HELLO_FROM_MONITOR");
            });

            conn.on('error', (err) => {
                log(`âŒ é€£ç·šå¤±æ•—: ç„¡æ³•é€£æ¥ ${targetId}ã€‚è«‹ç¢ºèªï¼š`);
                log(`1. æ‰‹æ©Ÿæ˜¯å¦è¢å¹•äº®è‘—ï¼Ÿ`);
                log(`2. ID æ˜¯å¦è¼¸å…¥æ­£ç¢ºï¼Ÿ`);
                log(`3. å…©è€…æ˜¯å¦åœ¨åŒä¸€å€‹ç¶²è·¯ç’°å¢ƒï¼Ÿ`);
            });
            
            // è¨­å®š 5 ç§’è¶…æ™‚æª¢æŸ¥
            setTimeout(() => {
                const vid = document.getElementById(`video-${targetId}`);
                if (!vid) {
                    log(`âš ï¸ 5ç§’éå»äº†ï¼Œé‚„æ²’æ”¶åˆ°å½±åƒã€‚è«‹é‡æ•´æ‰‹æ©Ÿç¶²é è©¦è©¦çœ‹ã€‚`);
                }
            }, 5000);
        }

        // --- é¡¯ç¤ºå½±åƒ ---
        function showVideo(id, stream) {
            const container = document.getElementById('video-container');
            
            // é¿å…é‡è¤‡å»ºç«‹
            if (document.getElementById(`wrapper-${id}`)) return;

            const div = document.createElement('div');
            div.className = 'vid-box';
            div.id = `wrapper-${id}`;
            div.innerHTML = `
                <div class="label">ID: ${id}</div>
                <video id="video-${id}" autoplay playsinline></video>
                <canvas id="canvas-${id}"></canvas>
            `;
            container.appendChild(div);

            const videoEl = document.getElementById(`video-${id}`);
            const canvasEl = document.getElementById(`canvas-${id}`);
            
            videoEl.srcObject = stream;
            
            // ç¢ºä¿å½±ç‰‡æ’­æ”¾
            videoEl.onloadedmetadata = () => {
                videoEl.play().catch(e => log("æ’­æ”¾å¤±æ•—(éœ€æ‰‹å‹•é»æ“Š):" + e));
                startPoseDetection(videoEl, canvasEl);
            };
        }

        // --- MediaPipe ç°¡å–®ç¹ªè£½ ---
        function startPoseDetection(videoElement, canvasElement) {
            const canvasCtx = canvasElement.getContext('2d');
            const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
            
            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            pose.onResults((results) => {
                canvasCtx.save();
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
                if (results.poseLandmarks) {
                    drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                    drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FF0000', lineWidth: 1});
                }
                canvasCtx.restore();
            });

            async function frame() {
                await pose.send({image: videoElement});
                requestAnimationFrame(frame);
            }
            frame();
        }
    </script>
</body>
</html>
