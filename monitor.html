<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>監控端 - IDYS Analysis</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        :root { --bg-color: #FAF9F6; --accent-color: #800020; --text-color: #333333; --gray-light: #E0E0E0; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Arial, sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Modal */
        #disclaimer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-color); padding: 40px; border-radius: 8px; max-width: 500px; text-align: center; border-top: 5px solid var(--accent-color); }
        .btn-primary { background-color: var(--accent-color); color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { opacity: 0.9; }
        
        /* Header 縮小一點，留更多空間給畫面 */
        header { text-align: center; padding: 10px 0; border-bottom: 1px solid var(--gray-light); background: white; z-index: 10; flex-shrink: 0; }
        h1 { margin: 0; font-weight: 700; color: var(--text-color); font-size: 24px; }
        .subtitle { color: var(--accent-color); font-size: 12px; margin-top: 5px; }
        
        .main-container { flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%; overflow: hidden; position: relative; }
        
        /* 設定面板 (連線成功後隱藏) */
        .setup-card { 
            background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            width: 90%; max-width: 600px; text-align: center; margin: 20px auto; 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50;
        }
        
        .camera-options { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .option-btn { background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: 0.2s; }
        .option-btn.active { background: var(--accent-color); color: white; }
        .option-btn:hover { background: rgba(128,0,32,0.1); }
        
        .input-group { margin: 15px 0; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold; color: #666; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        
        /* --- 視訊牆核心樣式 --- */
        #video-grid { 
            display: grid; 
            width: 100%; 
            height: 100%; 
            background: #000;
            gap: 2px; /* 分割線 */
        }

        /* 不同模式的 Grid 設定 */
        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        /* 如果是手機直立看，可能需要變成上下排 (這裡先以電腦橫螢幕為主) */
        
        /* 影片容器 */
        .video-wrapper { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background: #111;
            cursor: pointer; /* 讓滑鼠變手手，提示可點擊 */
            transition: all 0.3s ease;
        }
        
        /* 放大模式 (Fullscreen Overlay) */
        .video-wrapper.expanded {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999;
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }

        /* 影片與Canvas 疊加 */
        .video-wrapper video { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; 
            object-fit: contain; /* 保持比例，看到全身 */
            opacity: 0; /* 隱藏原始影片，只看 Canvas 繪圖結果 */
        }
        .output_canvas { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; 
            object-fit: contain; /* 必須與 video 一致 */
            display: block; 
        }
        
        .overlay-label { 
            position: absolute; top: 20px; left: 20px; 
            background: rgba(128, 0, 32, 0.8); color: white; 
            padding: 6px 12px; font-size: 14px; border-radius: 4px; 
            z-index: 10; font-weight: bold; pointer-events: none;
        }

        .expand-hint {
            position: absolute; bottom: 20px; right: 20px;
            color: rgba(255,255,255,0.5); font-size: 24px;
            pointer-events: none; z-index: 10;
        }
        
        footer { display: none; /* 監控模式下隱藏 footer 以爭取空間 */ }
    </style>
</head>
<body>

    <div id="disclaimer-modal">
        <div class="modal-content">
            <h2 style="color:var(--accent-color); margin-top:0;">IDYS 使用聲明</h2>
            <p style="text-align:left; line-height:1.6; color:#555;">本系統使用 AI 進行姿勢可視化分析，純供訓練參考<br>如有骨骼關節或肌肉等身體不適，請停止訓練並尋求正規醫療途徑。</p>
            <button class="btn-primary" onclick="closeModal()">我了解，繼續</button>
        </div>
    </div>

    <header>
        <h1>IDYS 動作回饋分析</h1>
        <div class="subtitle">I Do You See - 監控台</div>
    </header>

    <div class="main-container">
        <div class="setup-card" id="setup-panel">
            <h3>連線設定</h3>
            <p>請選擇鏡頭數量：</p>
            <div class="camera-options">
                <button class="option-btn active" onclick="setCamCount(1)">單鏡頭</button>
                <button class="option-btn" onclick="setCamCount(2)">雙鏡頭</button>
                <button class="option-btn" onclick="setCamCount(3)">三鏡頭</button>
            </div>
            
            <div id="inputs-area">
                <div class="input-group"><label>鏡頭 ID</label><input type="text" id="cam1-id" placeholder="輸入手機 ID"></div>
            </div>
            
            <button class="btn-primary" onclick="startSystem()">開始連線</button>
        </div>
        
        <div id="video-grid"></div>
    </div>

    <script>
        let currentMode = 1;
        const myPeer = new Peer(); 

        function closeModal() {
            document.getElementById('disclaimer-modal').style.display='none';
        }

        // --- 多鏡頭 UI 邏輯 ---
        function setCamCount(count) {
            currentMode = count;
            document.querySelectorAll('.option-btn').forEach((b, i) => {
                b.classList.toggle('active', i + 1 === count);
            });
            const area = document.getElementById('inputs-area');
            let html = '';
            if (count === 1) html += createInput("cam1-id", "主鏡頭 ID");
            if (count === 2) {
                html += createInput("cam1-id", "鏡頭 1 ID (建議:側面)");
                html += createInput("cam2-id", "鏡頭 2 ID (建議:背面)");
            }
            if (count === 3) {
                html += createInput("cam1-id", "鏡頭 1 ID (側面)");
                html += createInput("cam2-id", "鏡頭 2 ID (背面)");
                html += createInput("cam3-id", "鏡頭 3 ID (正面)");
            }
            area.innerHTML = html;
        }

        function createInput(id, label) {
            return `<div class="input-group"><label>${label}</label><input type="text" id="${id}" placeholder="輸入手機上的 4 位數 ID"></div>`;
        }

        // --- 系統啟動 ---
        function startSystem() {
            document.getElementById('setup-panel').style.display = 'none';
            const grid = document.getElementById('video-grid');
            grid.innerHTML = ''; 
            
            // 設定 Grid 版面模式
            grid.className = `grid-${currentMode}`;

            const configs = [];
            for(let i=1; i<=currentMode; i++) {
                const val = document.getElementById(`cam${i}-id`).value;
                if(val) configs.push({id: val, label: `鏡頭 ${i}`});
            }

            if(configs.length === 0) return alert("請至少輸入一組 ID");

            configs.forEach(conf => {
                createVideoBox(conf.label, conf.id);
                connectAndAnalyze(conf.id);
            });
        }

        function createVideoBox(label, id) {
            const grid = document.getElementById('video-grid');
            const div = document.createElement('div');
            div.className = `video-wrapper`;
            
            // 點擊放大/縮小功能
            div.onclick = function() {
                this.classList.toggle('expanded');
                // 當有畫面被放大時，鎖定背景滾動 (雖然已經 overflow hidden)
            };

            div.innerHTML = `
                <div class="overlay-label">${label}</div>
                <video id="vid-${id}" autoplay playsinline></video>
                <canvas id="canvas-${id}" class="output_canvas"></canvas>
                <div class="expand-hint">⛶</div> `;
            grid.appendChild(div);
        }

        // --- 連線與 AI 初始化 ---
        function connectAndAnalyze(targetId) {
            const conn = myPeer.connect(targetId);
            
            myPeer.on('call', (call) => {
                if (call.peer === targetId) {
                    call.answer();
                    call.on('stream', (remoteStream) => {
                        const videoEl = document.getElementById(`vid-${targetId}`);
                        const canvasEl = document.getElementById(`canvas-${targetId}`);
                        
                        if (videoEl && canvasEl) {
                            videoEl.srcObject = remoteStream;
                            videoEl.onloadedmetadata = () => {
                                videoEl.play();
                                initPoseAnalysis(videoEl, canvasEl);
                            };
                        }
                    });
                }
            });
        }

        // --- AI 分析模組 ---
        function initPoseAnalysis(videoElement, canvasElement) {
            const ctx = canvasElement.getContext('2d');
            const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
            
            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            pose.onResults((results) => {
                drawSkeleton(ctx, results);
            });

            async function step() {
                // 確保 Canvas 尺寸與 Video 顯示尺寸一致，這對 object-fit: contain 很重要
                // 我們這裡直接讓 canvas 的內部解析度 = 影片原始解析度
                // 顯示尺寸由 CSS 控制
                if(videoElement.videoWidth) {
                    canvasElement.width = videoElement.videoWidth;
                    canvasElement.height = videoElement.videoHeight;
                    await pose.send({image: videoElement});
                }
                requestAnimationFrame(step);
            }
            step();
        }

        function drawSkeleton(ctx, results) {
            const width = ctx.canvas.width;
            const height = ctx.canvas.height;
            
            ctx.save();
            ctx.clearRect(0, 0, width, height);
            
            // 繪製原始影像
            ctx.drawImage(results.image, 0, 0, width, height);

            if (results.poseLandmarks) {
                drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#FFFFFF', lineWidth: 3});
                drawLandmarks(ctx, results.poseLandmarks, {color: '#800020', lineWidth: 1, radius: 5});

                // 脊椎中軸線 (黃色虛線)
                const lm = results.poseLandmarks;
                const leftShoulder = lm[11];
                const rightShoulder = lm[12];
                const leftHip = lm[23];
                const rightHip = lm[24];

                if(leftShoulder && rightShoulder && leftHip && rightHip) {
                    const midS_X = (leftShoulder.x + rightShoulder.x) / 2;
                    const midS_Y = (leftShoulder.y + rightShoulder.y) / 2;
                    const midH_X = (leftHip.x + rightHip.x) / 2;
                    const midH_Y = (leftHip.y + rightHip.y) / 2;

                    ctx.beginPath();
                    ctx.strokeStyle = '#FFFF00';
                    ctx.lineWidth = 4;
                    ctx.setLineDash([15, 10]);
                    ctx.moveTo(midS_X * width, midS_Y * height);
                    ctx.lineTo(midH_X * width, midH_Y * height);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }
            ctx.restore();
        }
    </script>
</body>
</html>
