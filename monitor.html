<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>監控端 - IDYS Analysis</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        :root { --bg-color: #FAF9F6; --accent-color: #800020; --text-color: #333333; --gray-light: #E0E0E0; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Arial, sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Modal */
        #disclaimer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-color); padding: 40px; border-radius: 8px; max-width: 500px; text-align: center; border-top: 5px solid var(--accent-color); }
        .btn-primary { background-color: var(--accent-color); color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 4px; cursor: pointer; }
        
        header { text-align: center; padding: 20px 0; border-bottom: 1px solid var(--gray-light); background: white; z-index: 10; }
        h1 { margin: 0; font-weight: 700; color: var(--text-color); }
        .subtitle { color: var(--accent-color); font-size: 14px; margin-top: 8px; }
        
        .main-container { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .setup-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); width: 100%; max-width: 700px; text-align: center; margin-bottom: 20px; }
        
        .input-group { margin: 15px 0; text-align: left; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        
        #video-grid { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; width: 100%; margin-top: 20px; }
        
        /* 影片容器：包含原始影片(隱藏)與Canvas(顯示) */
        .video-wrapper { position: relative; background: #000; border-radius: 8px; overflow: hidden; width: 480px; aspect-ratio: 4/3; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* 讓原始影片隱藏但保持運作 */
        .video-wrapper video { position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0; }
        
        /* Canvas 蓋在上面 */
        .output_canvas { width: 100%; height: 100%; display: block; }
        
        .overlay-label { position: absolute; top: 10px; left: 10px; background: rgba(128, 0, 32, 0.9); color: white; padding: 4px 10px; font-size: 12px; border-radius: 4px; z-index: 10; font-weight: bold; }
        .alert-box { position: absolute; bottom: 10px; left: 10px; right: 10px; background: rgba(255,0,0,0.7); color: white; padding: 5px; font-size: 14px; border-radius: 4px; display: none; text-align: center; }
        
        footer { text-align: center; padding: 15px; font-size: 12px; color: #888; border-top: 1px solid var(--gray-light); }
    </style>
</head>
<body>

    <div id="disclaimer-modal">
        <div class="modal-content">
            <h2 style="color:var(--accent-color); margin-top:0;">IDYS 使用聲明</h2>
            <p style="text-align:left; line-height:1.6; color:#555;">本系統使用 AI 進行姿勢輔助分析。<br>若有身體不適請停止使用，並尋求專業醫療協助。</p>
            <button class="btn-primary" onclick="enableAudioAndStart()">我了解，開啟聲音並繼續</button>
        </div>
    </div>

    <header>
        <h1>IDYS 動作回饋分析</h1>
        <div class="subtitle">你是我的眼，帶我調整無數次的姿勢</div>
    </header>

    <div class="main-container">
        <div class="setup-card" id="setup-panel">
            <h3>連線設定</h3>
            <div class="input-group"><label>請輸入手機端 ID</label><input type="text" id="cam1-id" placeholder="例如：4821"></div>
            <button class="btn-primary" onclick="startSystem()">開始連線</button>
        </div>
        <div id="video-grid"></div>
    </div>

    <footer>&copy; 2025 IDYS System</footer>

    <script>
        const myPeer = new Peer(); 
        let audioContext;
        let isAudioEnabled = false;

        // 初始化音效 (瀏覽器政策要求使用者點擊後才能播放聲音)
        function enableAudioAndStart() {
            document.getElementById('disclaimer-modal').style.display='none';
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            isAudioEnabled = true;
        }

        // 發出嗶嗶聲
        function playAlertSound() {
            if (!isAudioEnabled || !audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5 note
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1); // 短音 0.1秒
        }

        // --- MediaPipe 設定 ---
        const pose = new Pose({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }});
        
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onPoseResults);

        function startSystem() {
            const id = document.getElementById('cam1-id').value;
            if(!id) return alert("請輸入 ID");
            
            document.getElementById('setup-panel').style.display = 'none';
            createVideoBox("主畫面分析", id);
            connectToCamera(id);
        }

        function createVideoBox(label, id) {
            const grid = document.getElementById('video-grid');
            const div = document.createElement('div');
            div.className = `video-wrapper`;
            div.innerHTML = `
                <div class="overlay-label">${label}</div>
                <video id="vid-${id}" autoplay playsinline></video>
                <canvas id="canvas-${id}" class="output_canvas"></canvas>
                <div id="alert-${id}" class="alert-box"></div>
            `;
            grid.appendChild(div);
        }

        function connectToCamera(targetId) {
            const conn = myPeer.connect(targetId);
            myPeer.on('call', (call) => {
                call.answer();
                call.on('stream', (remoteStream) => {
                    const videoEl = document.getElementById(`vid-${call.peer}`);
                    const canvasEl = document.getElementById(`canvas-${call.peer}`);
                    
                    if (videoEl) {
                        videoEl.srcObject = remoteStream;
                        videoEl.onloadedmetadata = () => {
                            videoEl.play();
                            // 啟動 AI 迴圈
                            startMediaPipeLoop(videoEl, canvasEl);
                        };
                    }
                });
            });
        }

        // 循環送畫面給 AI
        function startMediaPipeLoop(videoElement, canvasElement) {
            const ctx = canvasElement.getContext('2d');
            
            async function step() {
                // 調整 canvas 尺寸匹配影片
                if(videoElement.videoWidth) {
                    canvasElement.width = videoElement.videoWidth;
                    canvasElement.height = videoElement.videoHeight;
                    
                    // 傳送畫面給 Pose 模型
                    await pose.send({image: videoElement});
                }
                requestAnimationFrame(step);
            }
            step();
        }

        // --- AI 分析核心邏輯 ---
        let lastAlertTime = 0;

        function onPoseResults(results) {
            // 這裡假設只有一個畫面在跑，實際多畫面要改寫結構，目前先針對單畫面測試
            const canvas = document.querySelector('.output_canvas'); 
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.save();
            ctx.clearRect(0, 0, width, height);
            
            // 畫出原始影像
            ctx.drawImage(results.image, 0, 0, width, height);

            if (results.poseLandmarks) {
                // 1. 畫出骨架
                drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#FFFFFF', lineWidth: 2});
                drawLandmarks(ctx, results.poseLandmarks, {color: '#800020', lineWidth: 1, radius: 3});

                // 2. 畫出「虛擬中軸線」 (黃色)
                const leftShoulder = results.poseLandmarks[11];
                const rightShoulder = results.poseLandmarks[12];
                const leftHip = results.poseLandmarks[23];
                const rightHip = results.poseLandmarks[24];

                if(leftShoulder && rightShoulder && leftHip && rightHip) {
                    const midShoulderX = (leftShoulder.x + rightShoulder.x) / 2;
                    const midShoulderY = (leftShoulder.y + rightShoulder.y) / 2;
                    const midHipX = (leftHip.x + rightHip.x) / 2;
                    const midHipY = (leftHip.y + rightHip.y) / 2;

                    ctx.beginPath();
                    ctx.strokeStyle = '#FFFF00'; // 黃色中軸
                    ctx.lineWidth = 3;
                    ctx.setLineDash([10, 5]);
                    ctx.moveTo(midShoulderX * width, midShoulderY * height);
                    ctx.lineTo(midHipX * width, midHipY * height);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // --- 生物力學偵測邏輯 ---
                    analyzeSquat(results.poseLandmarks, midShoulderX, midHipX);
                }
            }
            ctx.restore();
        }

        function analyzeSquat(lm, midShoulderX, midHipX) {
            const alertBox = document.querySelector('.alert-box');
            let messages = [];
            
            // 閾值設定 (需依實際情況微調)
            const THRESHOLD_SHIFT = 0.05; // 軀幹歪斜
            const THRESHOLD_HIP_TILT = 0.04; // 骨盆高低
            const THRESHOLD_VALGUS = 0.03; // 膝蓋內夾

            // 1. 軀幹側移 (Spine Lateral Shift) - 背面/正面
            // 檢查肩膀中點與骨盆中點的 X 軸偏差
            if (Math.abs(midShoulderX - midHipX) > THRESHOLD_SHIFT) {
                messages.push("⚠️ 軀幹歪斜 (Shift)");
            }

            // 2. 骨盆水平歪斜 (Pelvic Tilt/Hike) - 背面/正面
            // 檢查左右髖關節 Y 軸高度差
            const hipDiff = Math.abs(lm[23].y - lm[24].y);
            if (hipDiff > THRESHOLD_HIP_TILT) {
                messages.push("⚠️ 骨盆高低不均");
            }

            // 3. 膝蓋內夾 (Knee Valgus) - 正面
            // 簡單判斷：膝蓋 X 座標是否比腳踝更靠內 (對於深蹲)
            // 左腳 (25膝, 27踝) / 右腳 (26膝, 28踝)
            // 注意：MediaPipe 座標 normalized, 0在左邊, 1在右邊
            // 這裡做一個簡單的寬度比較：如果膝蓋寬度 < 腳踝寬度 * 0.8，可能有內夾
            const kneeWidth = Math.abs(lm[25].x - lm[26].x);
            const ankleWidth = Math.abs(lm[27].x - lm[28].x);
            
            // 只有當全身都看得到時才偵測
            if (lm[27].visibility > 0.5 && lm[28].visibility > 0.5) {
                if (kneeWidth < ankleWidth * 0.8) { 
                    messages.push("⚠️ 膝蓋內夾 (Valgus)");
                }
            }

            // --- 顯示警告與聲音 ---
            if (messages.length > 0) {
                alertBox.style.display = 'block';
                alertBox.innerHTML = messages.join('<br>');
                
                // 聲音控制 (每秒最多叫一次，避免太吵)
                const now = Date.now();
                if (now - lastAlertTime > 1000) {
                    playAlertSound();
                    lastAlertTime = now;
                }
            } else {
                alertBox.style.display = 'none';
            }
        }
    </script>
</body>
</html>
