<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡é ­ç«¯ - IDYS</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --bg-color: #FAF9F6; --accent-color: #800020; --text-color: #333333; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h2 { color: var(--accent-color); font-weight: 700; margin-bottom: 20px; }
        
        .card {
            background: white; width: 100%; max-width: 400px; border-radius: 12px; padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; box-sizing: border-box;
            border-top: 4px solid var(--accent-color);
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 14px; color: #555; }
        select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: #fff; outline: none; }
        
        .btn-start {
            background-color: var(--accent-color); color: white; width: 100%; padding: 15px;
            border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .btn-start:active { opacity: 0.8; }

        /* åˆ‡æ›é¡é ­æŒ‰éˆ•æ¨£å¼ */
        .btn-switch {
            background-color: white; color: var(--accent-color); border: 1px solid var(--accent-color);
            padding: 8px 15px; border-radius: 20px; font-size: 14px; cursor: pointer; margin-top: 10px;
            display: flex; align-items: center; justify-content: center; gap: 5px; width: 100%;
        }
        .btn-switch:hover { background-color: #fcedf2; }
        
        #id-container { display: none; text-align: center; }
        .big-id { font-size: 36px; color: var(--accent-color); font-weight: 800; letter-spacing: 5px; margin: 15px 0; background: #f4f4f4; padding: 10px; border-radius: 8px; }
        
        /* å½±ç‰‡å®¹å™¨ */
        .video-container { position: relative; width: 100%; margin-top: 15px; }
        video { width: 100%; border-radius: 8px; background: #000; transform: scaleX(1); /* é è¨­ä¸é¡åƒ */ }
        
        /* ç•¶å‰é¡é ­æ™‚ï¼Œé€šå¸¸ç¿’æ…£é¡åƒé¡¯ç¤ºï¼Œå¯é€é JS æ§åˆ¶ class */
        video.mirrored { transform: scaleX(-1); }

        .status-badge { display: inline-block; padding: 6px 12px; background: #eee; border-radius: 20px; font-size: 13px; color: #666; margin-top: 5px; font-weight: 500; }
        .status-badge.connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        
        .footer-info { font-size: 12px; color: #999; margin-top: auto; }
    </style>
</head>
<body>
    <h2>IDYS é¡é ­ç«¯ (I Do)</h2>

    <div class="card" id="settings-card">
        <div class="form-group">
            <label>1. è¨­å®šè¨“ç·´é …ç›®</label>
            <select id="exercise-type">
                <option value="squat">æ·±è¹² (Squat)</option>
                <option value="deadlift">ç¡¬èˆ‰ (Deadlift)</option>
            </select>
        </div>
        <div class="form-group">
            <label>2. ç•«é¢æ‹æ”è§’åº¦</label>
            <select id="camera-angle">
                <option value="sagittal">å´é¢è§€ (Side)</option>
                <option value="frontal_back">èƒŒé¢è§€ (Back)</option>
                <option value="frontal_front">æ­£é¢è§€ (Front)</option>
            </select>
        </div>
        <button class="btn-start" onclick="initCamera()">å•Ÿå‹•é¡é ­ & ç²å– ID</button>
    </div>

    <div class="card" id="id-container">
        <label>è«‹å°‡æ­¤è™Ÿç¢¼è¼¸å…¥è‡³é›»è…¦ç«¯ï¼š</label>
        <div class="big-id" id="my-peer-id">...</div>
        <div class="status-badge" id="conn-status">å•Ÿå‹•ä¸­...</div>
        
        <div class="video-container">
            <video id="localVideo" autoplay muted playsinline></video>
        </div>

        <button class="btn-switch" onclick="switchCamera()">
            ğŸ”„ åˆ‡æ›å‰å¾Œé¡é ­
        </button>
        
        <p style="font-size:12px; color:#888; margin-top:10px;">è«‹ä¿æŒè¢å¹•é–‹å•Ÿï¼Œå‹¿é–å®šæ‰‹æ©Ÿ</p>
    </div>
    
    <div class="footer-info">&copy; 2025å¹´ IDYS å‹•ä½œå›é¥‹åˆ†æç³»çµ±</div>

    <script>
        let peer;
        let localStream;
        let currentCall = null; // å„²å­˜ç•¶å‰çš„é€šè©±é€£ç·šï¼Œä»¥ä¾¿åˆ‡æ›é¡é ­æ™‚æ›´æ–°
        let currentFacingMode = 'environment'; // é è¨­ä½¿ç”¨å¾Œé¡é ­

        function generateShortId() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        function initPeer() {
            const shortId = generateShortId();
            peer = new Peer(shortId);

            peer.on('open', (id) => {
                document.getElementById('my-peer-id').innerText = id;
                document.getElementById('conn-status').innerText = "ç­‰å¾…é›»è…¦é€£ç·š...";
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    peer.destroy();
                    setTimeout(initPeer, 200);
                } else {
                    alert("é€£ç·šéŒ¯èª¤: " + err.type);
                }
            });

            peer.on('connection', (conn) => {
                const badge = document.getElementById('conn-status');
                badge.innerText = "âœ… å·²é€£ç·šè‡³ä¸»æ§å°";
                badge.classList.add('connected');
                
                // ç•¶æ•¸æ“šé€£ç·šå»ºç«‹æ™‚ï¼Œç™¼èµ·å½±åƒé€šè©±
                if(localStream) {
                    currentCall = peer.call(conn.peer, localStream);
                }
            });
            
            // è™•ç†è¢«å‹•çš„é€šè©±è«‹æ±‚ (å¦‚æœé›»è…¦ç«¯ç™¼èµ·)
            peer.on('call', (call) => {
                call.answer(localStream);
                currentCall = call;
            });
        }

        async function initCamera() {
            const settingsCard = document.getElementById('settings-card');
            const idContainer = document.getElementById('id-container');
            const statusBadge = document.getElementById('conn-status');

            settingsCard.style.display = 'none';
            idContainer.style.display = 'block';
            statusBadge.innerText = "æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...";

            await startVideo(currentFacingMode);
            
            statusBadge.innerText = "ç›¸æ©Ÿå°±ç·’ï¼Œæ­£åœ¨ç²å– ID...";
            initPeer();
        }

        // ç¨ç«‹å‡ºå•Ÿå‹•è¦–è¨Šçš„å‡½å¼
        async function startVideo(facingMode) {
            try {
                // å¦‚æœå·²ç¶“æœ‰é–‹å•Ÿçš„ä¸²æµï¼Œå…ˆåœæ­¢å®ƒ (é‡‹æ”¾è³‡æº)
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }

                const constraints = { 
                    video: { 
                        facingMode: facingMode, 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 } 
                    }, 
                    audio: false 
                };

                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const videoEl = document.getElementById('localVideo');
                videoEl.srcObject = localStream;

                // å¦‚æœæ˜¯å‰é¡é ­ï¼ŒåŠ ä¸Šé¡åƒæ•ˆæœæ¯”è¼ƒè‡ªç„¶
                if (facingMode === 'user') {
                    videoEl.classList.add('mirrored');
                } else {
                    videoEl.classList.remove('mirrored');
                }

                return localStream;

            } catch (err) {
                console.error(err);
                alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹ç¢ºèªæ¬Šé™ã€‚\nè‹¥ä½¿ç”¨ iOSï¼Œè«‹ç¢ºä¿åœ¨ Safari é–‹å•Ÿã€‚");
                throw err;
            }
        }

        // åˆ‡æ›é¡é ­çš„æ ¸å¿ƒé‚è¼¯
        async function switchCamera() {
            // 1. åˆ‡æ›æ¨¡å¼ç‹€æ…‹
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
            
            // 2. é‡æ–°å•Ÿå‹•ç›¸æ©Ÿ
            const newStream = await startVideo(currentFacingMode);

            // 3. å¦‚æœç›®å‰æ­£åœ¨é€£ç·šä¸­ï¼Œéœ€è¦ã€Œç„¡ç¸«æ›¿æ›ã€å‚³é€çµ¦é›»è…¦çš„è»Œé“
            if (currentCall && currentCall.peerConnection) {
                const videoTrack = newStream.getVideoTracks()[0];
                
                // æ‰¾åˆ°è² è²¬å‚³é€å½±åƒçš„ Sender
                const sender = currentCall.peerConnection.getSenders().find((s) => s.track.kind === 'video');
                
                if (sender) {
                    // æ›¿æ›è»Œé“ï¼Œé›»è…¦ç«¯ä¸æœƒæ–·ç·šï¼Œåªæœƒçœ‹åˆ°ç•«é¢è®Šäº†
                    sender.replaceTrack(videoTrack);
                    console.log("å·²åˆ‡æ›é€£ç·šä¸­çš„å½±åƒè»Œé“");
                }
            }
        }
    </script>
</body>
</html>
