<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡é ­ç«¯ (é™¤éŒ¯æ¨¡å¼)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #FAF9F6; padding: 20px; text-align: center; }
        
        #log-box {
            background: #333; color: #0f0; font-family: monospace;
            padding: 10px; height: 150px; overflow-y: scroll;
            text-align: left; font-size: 12px; margin-bottom: 20px;
            border-radius: 8px;
        }

        video { width: 100%; border-radius: 8px; background: #000; }
        
        .big-id { font-size: 32px; color: #800020; font-weight: bold; margin: 10px 0; }
        
        button {
            padding: 15px 30px; font-size: 18px; background: #800020;
            color: white; border: none; border-radius: 8px; cursor: pointer;
            width: 100%; margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <h2>é¡é ­ç«¯ (é™¤éŒ¯ç‰ˆ)</h2>
    
    <div id="log-box">ç­‰å¾…æ“ä½œ...<br></div>

    <button onclick="startCamera()">1. å•Ÿå‹•ç›¸æ©Ÿ & ç²å– ID</button>

    <div id="info-area" style="display:none;">
        <p>ä½ çš„ ID (è«‹è¼¸å…¥åˆ°é›»è…¦):</p>
        <div class="big-id" id="my-id">...</div>
        <video id="localVideo" autoplay muted playsinline></video>
    </div>

    <script>
        // æ—¥èªŒåŠŸèƒ½
        function log(msg) {
            const box = document.getElementById('log-box');
            const time = new Date().toLocaleTimeString();
            box.innerHTML = `[${time}] ${msg}<br>` + box.innerHTML;
        }

        let peer;
        let localStream;

        async function startCamera() {
            log("æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...");
            try {
                // 1. å…ˆæ‹¿ç›¸æ©Ÿ
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: 640 }, 
                    audio: false 
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('info-area').style.display = 'block';
                log("âœ… ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸï¼æ­£åœ¨é€£ç·šä¼ºæœå™¨...");

                // 2. å†é€£ PeerJS
                initPeer();

            } catch (err) {
                log("âŒ ç›¸æ©Ÿå¤±æ•—: " + err.message);
                alert("è«‹ç¢ºèªä½ æ˜¯ç”¨ Safari (iOS) æˆ– Chrome (Android)ï¼Œä¸è¦ç”¨ Line é–‹ï¼");
            }
        }

        function initPeer() {
            // ç”¢ç”Ÿéš¨æ©Ÿ 4 ä½æ•¸ ID
            const shortId = Math.floor(1000 + Math.random() * 9000).toString();
            peer = new Peer(shortId);

            peer.on('open', (id) => {
                document.getElementById('my-id').innerText = id;
                log(`âœ… ID ç²å–æˆåŠŸ: ${id}`);
                log(`ğŸ‘‰ è«‹åœ¨é›»è…¦è¼¸å…¥æ­¤ ID`);
            });

            peer.on('error', (err) => {
                log(`âŒ Peer éŒ¯èª¤: ${err.type}`);
            });

            // é—œéµï¼šç›£è½é›»è…¦é€£ç·š
            peer.on('connection', (conn) => {
                log(`ğŸ“ æ”¶åˆ°é›»è…¦ (${conn.peer}) çš„é€£ç·šè«‹æ±‚ï¼`);
                log(`ğŸš€ æ­£åœ¨å›å‚³å½±åƒçµ¦é›»è…¦...`);
                
                if (localStream) {
                    // ä¸»å‹•å›æ’¥å½±åƒ
                    const call = peer.call(conn.peer, localStream);
                    
                    call.on('close', () => { log("é€£ç·šçµæŸ"); });
                    call.on('error', (err) => { log("å›å‚³å¤±æ•—: " + err); });
                    
                    log(`ğŸ“¡ å½±åƒè¨Šè™Ÿå·²ç™¼é€ï¼`);
                } else {
                    log(`âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç›¸æ©Ÿå½±åƒæµï¼Œç„¡æ³•å›å‚³ã€‚`);
                }
            });
        }
    </script>
</body>
</html>
